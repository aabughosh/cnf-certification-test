<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset=utf-8>
  <title>TNF claim.json parser</title>
  <meta charset="utf-8">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">

  <style type="text/css">
    li.dropdown-menu {
      background-color: white;
    }

    table {
      border-collapse: collapse;
    }

    table td {
      border: 1px solid #000;
    }
  </style>
</head>

<body>
  <nav class="navbar navbar-dark bg-dark">
    <a class="navbar-brand" href="#">Test Network Function result parser</a>
    <div class="mb-3">
      <label for="formFile" class="form-label text-light">Upload claim.json file</label>
      <input class="form-control" type="file" id="formFile">
      <label for="selectBox" class="form-label text-light">
        Choose a scenario:</label>
      <select name="class" id="selectBox" onchange="changeFunc()">
        <option value="all"> All</option>
        <option value="faredge"> Far Edge</option>
        <option value="telco"> Telco</option>
        <option value="nontelco"> Non Telco</option>
      </select>
    </div>
  </nav>

  <button class="w3-button w3-right w3-light-grey" id="download" type="submit" onclick=download()
    hidden="hidden">Download</button>
  <button class="w3-button w3-right w3-light-grey" id="send" type="submit" onclick=sendMail()
    hidden="hidden">sendMail</button>

  <ul class="nav nav-tabs">
    <li class="nav-item">
      <button class="nav-link active" id="config-tab" data-bs-toggle="tab" data-bs-target="#config" type="button"
        role="tab" aria-controls="config" aria-selected="true" onclick="disableAllButton()">Configuration</button>
    </li>
    <li class="nav-item">
      <button class="nav-link" id="metadata-tab" data-bs-toggle="tab" data-bs-target="#metadata" type="button"
        role="tab" aria-controls="metadata" aria-selected="false" onclick="disableAllButton()">Metadata</button>
    </li>
    <li class="nav-item">
      <button class="nav-link" id="nodes-tab" data-bs-toggle="tab" data-bs-target="#nodes" type="button" role="tab"
        aria-controls="nodes" aria-selected="false" onclick="disableAllButton()">Nodes</button>
    </li>
    <li class="nav-item">
      <button class="nav-link" id="result-tab" data-bs-toggle="tab" data-bs-target="#results" type="button" role="tab"
        aria-controls="nodes" aria-selected="false" onclick="enableOptionButton()">Results</button>
    </li>
    <li class="nav-item">
      <button class="nav-link" id="versions-tab" data-bs-toggle="tab" data-bs-target="#versions" type="button"
        role="tab" aria-controls="versions" aria-selected="false" onclick="disableAllButton()">Versions</button>
    </li>
    <li class="nav-item">
      <button class="nav-link" id="feedback-tab" data-bs-toggle="tab" data-bs-target="#feedback" type="button"
        role="tab" aria-controls="nodes" aria-selected="false" onclick="enableOptionButtonFeedback()">Feedback</button>
    </li>
  </ul>
  <ul class="nav nav-tabs">
    <li class="nav-item">
      <label id="myCheck-mandatory" for="mandatory-tab" hidden="hidden">Show Mandatory Results for that scenario</label>
      <input type="checkbox" id="mandatory-tab" data-bs-target="#results" data-bs-toggle="tab" role="tab" checked
        onclick="showMandatoryResults()" hidden="hidden">
      <label id="myCheck-feedback-mandatory" for="mandatory-tab-feedback" hidden="hidden">Show Mandatory feedback for
        that scenario</label>
      <input type="checkbox" id="mandatory-tab-feedback" data-bs-target="#feedback" data-bs-toggle="tab" role="tab"
        checked onclick="showMandatoryFeedback()" hidden="hidden">

      <label id="myCheck-result" for="optional-tab" hidden="hidden">Show Optional Results for that scenario</label>
      <input type="checkbox" id="optional-tab" data-bs-target="#results" data-bs-toggle="tab" role="tab"
        onclick="showOptionalResults()" hidden="hidden">
      <label id="myCheck-feedback" for="optional-tab-feedback" hidden="hidden">Show Optional feedback for that
        scenario</label>
      <input type="checkbox" id="optional-tab-feedback" data-bs-target="#feedback" data-bs-toggle="tab" role="tab"
        onclick="showOptionalFeedback()" hidden="hidden">

    </li>
  </ul>
  <div class="tab-content" id="myTabContent">
    <div class="tab-pane fade show active" id="config" role="tabpanel" aria-labelledby="config-tab">
      <table class="table table-hover table-bordered" id="config-table">
      </table>
    </div>
    <div class="tab-pane fade" id="metadata" role="tabpanel" aria-labelledby="metadata-tab">
      <table class="table table-hover table-bordered" id="metadata-table">
      </table>
    </div>
    <div class="tab-pane fade" id="nodes" role="tabpanel" aria-labelledby="nodes-tab">
      <table class="table table-hover table-bordered" id="nodes-table">
      </table>
    </div>

    <div class="tab-pane fade" id="results" role="tabpanel" aria-labelledby="result-tab">
      <table class="table table-hover table-bordered" id="results-table" hidden="hidden">
      </table>
      <table class="table table-hover table-bordered" id="results-far-edge-table" hidden="hidden">
      </table>
      <table class="table table-hover table-bordered" id="optional-table" hidden="hidden">
      </table>
      <table class="table table-hover table-bordered" id="results-telco-table" hidden="hidden">
      </table>
      <table class="table table-hover table-bordered" id="optional-table-telco" hidden="hidden">
      </table>
      <table class="table table-hover table-bordered" id="results-NonTelco-table" hidden="hidden">
      </table>
      <table class="table table-hover table-bordered" id="optional-table-non-telco" hidden="hidden">
      </table>
    </div>


    <div class="tab-pane fade" id="versions" role="tabpanel" aria-labelledby="versions-tab">
      <table class="table table-hover table-bordered" id="versions-table">
      </table>
    </div>
    <div class="tab-pane fade" id="feedback" role="tabpanel" aria-labelledby="feedback-tab">
      <table class="table table-hover table-bordered" id="feedback-table-faredge" hidden="hidden">
      </table>
      <table class="table table-hover table-bordered" id="feedback-table-non-telco" hidden="hidden">
      </table>
      <table class="table table-hover table-bordered" id="feedback-table-telco" hidden="hidden">
      </table>
      <table class="table table-hover table-bordered" id="feedback-all" hidden="hidden">
      </table>
      <table class="table table-hover table-bordered" id="optional-table-telco-feedback" hidden="hidden">
      </table>
    </div>
    <table class="table table-hover table-bordered" id="optional-table-non-telco-feedback" hidden="hidden">
    </table>
    <table class="table table-hover table-bordered" id="optional-faredge-feedback" hidden="hidden">
    </table>
  </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"
    integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
    crossorigin="anonymous"></script>
  <script src="https://unpkg.com/ansi_up@5.1.0/ansi_up.js" crossorigin="anonymous"></script>
  <!-- We should extract the javascript code to a separate file, but if we include it here we can just use a single file HTMl, which is handy -->
  <!--    <script src="./utils.js"></script> -->
  <script>
    var buttonElementId = "non"



    function showOptionalFeedback() {
      var checkBox = document.getElementById("optional-tab-feedback");
      var selectBox = document.getElementById("selectBox");
      var selectedValue = selectBox.options[selectBox.selectedIndex].value;
      console.log(selectedValue)
      console.log(checkBox.checked)
      if (selectedValue == "faredge") {
        if (checkBox.checked == true) {
          document.getElementById("optional-faredge-feedback").removeAttribute("hidden");

        } else {
          document.getElementById("optional-faredge-feedback").setAttribute("hidden", "hidden");
        }

      }

      if (selectedValue == "nontelco") {
        if (checkBox.checked == true) {
          document.getElementById("optional-table-non-telco-feedback").removeAttribute("hidden");


        } else {
          document.getElementById("optional-table-non-telco-feedback").setAttribute("hidden", "hidden");
        }
      }


      if (selectedValue == "telco") {
        if (checkBox.checked == true) {
          document.getElementById("optional-table-telco-feedback").removeAttribute("hidden");


        } else {
          document.getElementById("optional-table-telco-feedback").setAttribute("hidden", "hidden");
        }
      }

    }



    function showMandatoryFeedback() {
      var checkBox = document.getElementById("mandatory-tab-feedback");
      var selectBox = document.getElementById("selectBox");
      var selectedValue = selectBox.options[selectBox.selectedIndex].value;
      if (selectedValue == "faredge") {
        if (checkBox.checked == true) {
          document.getElementById("feedback-table-faredge").removeAttribute("hidden");


        } else {
          document.getElementById("feedback-table-faredge").setAttribute("hidden", "hidden");
        }

      }

      if (selectedValue == "nontelco") {
        if (checkBox.checked == true) {
          document.getElementById("feedback-table-non-telco").removeAttribute("hidden");;


        } else {
          document.getElementById("feedback-table-non-telco").setAttribute("hidden", "hidden");
        }
      }


      if (selectedValue == "telco") {
        if (checkBox.checked == true) {
          document.getElementById("feedback-table-telco").removeAttribute("hidden");


        } else {
          document.getElementById("feedback-table-telco").setAttribute("hidden", "hidden");
        }
      }

    }



    function enableOptionButtonFeedback() {
      disableAllButton()
      buttonElementId = "feedback-tab"
      enableSendDownload()

      var selectBox = document.getElementById("selectBox");
      var selectedValue = selectBox.options[selectBox.selectedIndex].value;
      console.log(selectedValue)
      if (selectedValue == "all") {
        showAll()
      }
      else {
        document.getElementById("feedback-all").setAttribute("hidden", "hidden");

        document.getElementById("myCheck-feedback").removeAttribute("hidden");
        document.getElementById("optional-tab-feedback").removeAttribute("hidden");
        document.getElementById("myCheck-feedback-mandatory").removeAttribute("hidden");
        document.getElementById("mandatory-tab-feedback").removeAttribute("hidden");
      }
      showMandatoryFeedback()
      showOptionalFeedback()

    }

    function changeFunc() {
      var selectBox = document.getElementById("selectBox");
      var selectedValue = selectBox.options[selectBox.selectedIndex].value;

      console.log("click on ", buttonElementId)

      if (buttonElementId == "feedback-tab") {
        enableOptionButtonFeedback()


      }
      if (buttonElementId == "result-tab") {
        console.log("click on result ")
        enableOptionButton()
      }
    }

    function enableOptionButton() {
      disableAllButton()
      buttonElementId = "result-tab"
      var selectBox = document.getElementById("selectBox");
      var selectedValue = selectBox.options[selectBox.selectedIndex].value;
      console.log(selectedValue)
      if (selectedValue == "all") {
        showAll()
      }
      else {
        document.getElementById("results-table").setAttribute("hidden", "hidden");
        document.getElementById("myCheck-result").removeAttribute("hidden");
        document.getElementById("optional-tab").removeAttribute("hidden");
        document.getElementById("myCheck-mandatory").removeAttribute("hidden");
        document.getElementById("mandatory-tab").removeAttribute("hidden");
      }
      showOptionalResults()
      showMandatoryResults()
    }

    function showOptionalResults() {
      var checkBox = document.getElementById("optional-tab");
      var selectBox = document.getElementById("selectBox");
      var selectedValue = selectBox.options[selectBox.selectedIndex].value;
      if (selectedValue == "faredge") {
        if (checkBox.checked == true) {
          document.getElementById("optional-table").removeAttribute("hidden");
        } else {
          document.getElementById("optional-table").setAttribute("hidden", "hidden");
        }
      }
      if (selectedValue == "telco") {
        if (checkBox.checked == true) {
          document.getElementById("optional-table-telco").removeAttribute("hidden");
        } else {
          document.getElementById("optional-table-telco").setAttribute("hidden", "hidden");
        }
      }
      if (selectedValue == "nontelco") {
        if (checkBox.checked == true) {
          document.getElementById("optional-table-non-telco").removeAttribute("hidden");
        } else {
          document.getElementById("optional-table-non-telco").setAttribute("hidden", "hidden");
        }
      }
    }

    function showMandatoryResults() {
      var checkBox = document.getElementById("mandatory-tab");
      var selectBox = document.getElementById("selectBox");
      var selectedValue = selectBox.options[selectBox.selectedIndex].value;
      if (selectedValue == "faredge") {
        if (checkBox.checked == true) {
          document.getElementById("results-far-edge-table").removeAttribute("hidden");
        } else {
          document.getElementById("results-far-edge-table").setAttribute("hidden", "hidden");
        }
      }
      if (selectedValue == "telco") {
        if (checkBox.checked == true) {
          document.getElementById("results-telco-table").removeAttribute("hidden");
        } else {
          document.getElementById("results-telco-table").setAttribute("hidden", "hidden");
        }
      }
      if (selectedValue == "nontelco") {
        if (checkBox.checked == true) {
          document.getElementById("results-NonTelco-table").removeAttribute("hidden");
        } else {
          document.getElementById("results-NonTelco-table").setAttribute("hidden", "hidden");
        }
      }

    }

    function showAll() {
      console.log("in show all")

      document.getElementById("results-far-edge-table").setAttribute("hidden", "hidden");
      document.getElementById("results-telco-table").setAttribute("hidden", "hidden");
      document.getElementById("results-NonTelco-table").setAttribute("hidden", "hidden");

      document.getElementById("optional-table").setAttribute("hidden", "hidden");
      document.getElementById("optional-table-telco").setAttribute("hidden", "hidden");
      document.getElementById("optional-table-non-telco").setAttribute("hidden", "hidden");

      document.getElementById("feedback-table-faredge").setAttribute("hidden", "hidden");
      document.getElementById("feedback-table-non-telco").setAttribute("hidden", "hidden");
      document.getElementById("feedback-table-telco").setAttribute("hidden", "hidden");

      document.getElementById("optional-faredge-feedback").setAttribute("hidden", "hidden");
      document.getElementById("optional-table-non-telco-feedback").setAttribute("hidden", "hidden");
      document.getElementById("optional-table-telco-feedback").setAttribute("hidden", "hidden");



      document.getElementById("results-table").removeAttribute("hidden");
      document.getElementById("feedback-all").removeAttribute("hidden");
    }

    function enableSendDownload() {
      document.getElementById("download").removeAttribute("hidden");
      document.getElementById("send").removeAttribute("hidden");

    }


    function disableAllButton() {
      buttonElementId = "non"
      document.getElementById("optional-faredge-feedback").setAttribute("hidden", "hidden");
      document.getElementById("optional-table-non-telco-feedback").setAttribute("hidden", "hidden");
      document.getElementById("optional-table-telco-feedback").setAttribute("hidden", "hidden");

      document.getElementById("feedback-table-non-telco").setAttribute("hidden", "hidden");
      document.getElementById("feedback-table-telco").setAttribute("hidden", "hidden");
      document.getElementById("feedback-table-faredge").setAttribute("hidden", "hidden");

      document.getElementById("results-far-edge-table").setAttribute("hidden", "hidden");
      document.getElementById("results-NonTelco-table").setAttribute("hidden", "hidden");
      document.getElementById("results-telco-table").setAttribute("hidden", "hidden");

      document.getElementById("optional-table").setAttribute("hidden", "hidden");
      document.getElementById("optional-table-non-telco").setAttribute("hidden", "hidden");
      document.getElementById("optional-table-telco").setAttribute("hidden", "hidden");

      document.getElementById("optional-tab").setAttribute("hidden", "hidden");
      document.getElementById("mandatory-tab").setAttribute("hidden", "hidden");
      document.getElementById("optional-tab-feedback").setAttribute("hidden", "hidden");
      document.getElementById("send").setAttribute("hidden", "hidden");
      document.getElementById("download").setAttribute("hidden", "hidden");
      document.getElementById("myCheck-result").setAttribute("hidden", "hidden");
      document.getElementById("myCheck-feedback").setAttribute("hidden", "hidden");
      document.getElementById("myCheck-mandatory").setAttribute("hidden", "hidden");
      document.getElementById("myCheck-feedback-mandatory").setAttribute("hidden", "hidden");
      document.getElementById("mandatory-tab-feedback").setAttribute("hidden", "hidden");
    }
    function fillVersions(input, element) {
      $(element).empty()

      text = '<thead><tr><th scope="col">Component</th><th scope="col">Version</th></tr></thead><tbody>'
      $(text).appendTo($(element))

      for (const key in input) {
        versionstext = '<tr><td><b>' + key + '</b></td><td>' + input[key] + '</td></tr>'
        $(versionstext).appendTo($(element))
      }

      text = '</tbody>'
      $(text).appendTo($(element))
    }

    function fillMetadata(input, element) {
      $(element).empty()
      text = '<tbody>'
      $(text).appendTo($(element))

      for (const key in input) {
        text = '<tr><td><b>' + key + '</b></td><td>' + input[key] + '</td></tr>'
        $(text).appendTo($(element))
      }

      text = '</tbody>'
      $(text).appendTo($(element))
    }

    function innerFill(input) {
      text = ''
      // This utility function will return a table with the elements in input
      if (typeof input === 'string') {
        text = input
      } else if (Array.isArray(input)) {
        text += '<table class="table table-light table-bordered">'
        // Gather header from first item
        text += '<thead><tr>'

        if (typeof input[0] === 'object' && input !== null) {
          for (const key2 in input[0]) {
            text += '<th scope="col">' + key2 + '</th>'
          }
        }
        text += '</tr></thead><tbody>'

        for (const item of input) {
          text += '<tr>'
          if (typeof item === 'string') {
            text += '<td>' + item + '</td>'
          } else {
            for (const key2 in item) {
              text += '<td>' + innerFill(item[key2]) + '</td>'
            }
          }
          text += '</tr>'
        }
        text += '</tbody></table>'
      } else if (typeof input === 'object' && input !== null) {
        text += '<table class="table table-light table-bordered"><tbody>'
        // Go down the rabbit hole
        for (const key in input) {
          text += '<tr><td><b>' + key + '</b></td><td>'
          text += innerFill(input[key]) + '</td></tr>'
        }
        text += '</tbody></table>'
      } else {
        // What else could it be?
        text = input
      }
      return text
    }


    function fillConfig(input, element) {
      $(element).empty()
      var text = '<tbody>'
      $(text).appendTo($(element))

      for (const key in input) {
        text = '<tr><td><b>' + key + '</b></td><td>'
        // Go down the rabbit hole
        text += innerFill(input[key]) + '</td></tr>'
        $(text).appendTo($(element))
      }

      text = '</tbody>'
      $(text).appendTo($(element))
    }

    function fillResults(input, input2, element, element2, tableName) {
      $(element).empty()
      $(element2).empty()

      // The results object is composed of multiple objects, 1 per test
      // Inside the object we have an array of results
      id = 1
      var ansi_up = new AnsiUp;

      tests_total = 0
      tests_passed = 0
      tests_skipped = 0
      tests_failed = 0
      tests_total_optional = 0
      tests_passed_optional = 0
      tests_skipped_optional = 0
      tests_failed_optional = 0
      // Compute number of passed/skipped/failed results
      for (const key in input) {

        for (const item of input[key]) {
          for (const key2 in input2) {

            eqData = input2[key2].FarEdge

            if (tableName == "telco") {
              eqData = input2[key2].Telco

            }
            if (tableName == "nontelco") {
              eqData = input2[key2].NonTelco
            }

            if (key == key2) {
              if (item.state == 'passed') {
                if (eqData == "Mandatory" || tableName == "all") {
                  tests_total++
                  tests_passed++
                } else {
                  tests_total_optional++
                  tests_passed_optional++
                }

              } else if (item.state == 'skipped') {
                if (eqData == "Mandatory" || tableName == "all") {
                  tests_total++
                  tests_skipped++
                } else {
                  tests_total_optional++
                  tests_skipped_optional++
                }

              } else if (item.state == 'failed') {
                if (eqData == "Mandatory" || tableName == "all") {
                  tests_total++
                  tests_failed++
                } else {
                  tests_total_optional++
                  tests_failed_optional++
                }
              }
            }
          }
        }
      }


      if (tableName == "all") {
        text3 = '<thead><tr><th scope="col">All Test  summary</th><th scope="col">Test feedback</th></tr></thead><tbody>'
      } else {
        text3 = '<thead><tr><th scope="col">Mandatory Test  summary</th><th scope="col">Test feedback</th></tr></thead><tbody>'
      }
      text2 = '<thead><tr><th scope="col">Optional Test summary</th><th scope="col">Test results</th></tr></thead><tbody>'
      text2 += '<tr><td class="align-top"><b>Total:</b> ' + tests_total_optional + '<br><b>Passed:</b> ' + tests_passed_optional + '<br><b>Skipped:</b> ' + tests_skipped_optional + '<br><b>Failed:</b> ' + tests_failed_optional + '</td><td>'
      text2 += '<div class="accordion" id="results-accordion">'
      // First we will have a left column in the table with the summarized results
      text3 += '<tr><td class="align-top"><b>Total:</b> ' + tests_total + '<br><b>Passed:</b> ' + tests_passed + '<br><b>Skipped:</b> ' + tests_skipped + '<br><b>Failed:</b> ' + tests_failed + '</td><td>'
      text3 += '<div class="accordion" id="results-accordion">'
      for (const key in input) {
        //  console.log("key =",key)
        for (const key2 in input2) {

          eqData = input2[key2].FarEdge

          if (tableName == "telco") {
            eqData = input2[key2].Telco

          }
          if (tableName == "nontelco") {
            eqData = input2[key2].NonTelco
          }

          if (key == key2) {

            text = ''
            // NOTE: we are assuming the test result is determined by the passed/failed state of the first item
            status = input[key][0].state
            if (status === "passed") {
              buttontype = 'bg-success text-white'
            } else if (status === "skipped") {
              buttontype = 'bg-warning text-black'
            } else {
              buttontype = 'bg-danger text-white'
            }

            itemid = 'collapse' + id
            headingid = 'heading' + id
            text += '<div class="accordion-item"><h2 class="accordion-header" id="' + headingid + '"><button class="accordion-button collapsed ' + buttontype + '" type="button" data-bs-toggle="collapse" data-bs-target="#' + itemid + '" aria-expanded="true" aria-controls="' + itemid + '">'
            text += key + '</button></h2>'
            // Now we should populate the item contents
            text += '<div id="' + itemid + '" class="accordion-collapse collapse" aria-labelledby="' + headingid + '">'
            text += '<div class="accordion-body">'
            // Inside the accordion, 1 table with the following colummns
            text += '<table class="table table-bordered table-fixed"><thead><tr>'
            text += '<th scope="col" class="th-sm">Test ID</th>'
            text += '<th scope="col" class="th-sm">Test Text</th>'
            text += '<th scope="col" class="th-sm">Duration</th>'
            text += '<th scope="col" class="th-sm">State</th>'
            text += '<th scope="col" class="th-lg">Test output</th>'
            text += '</tr></thead><tbody>'
            // Note we are skipping some columns for now
            // And 1 row per test
            for (const item of input[key]) {
              text += '<tr><td>' + item.testID.id + '</td>'
              text += '<td>' + item.testText.replace(/\n/g, '<br>') + '</td>'
              text += '<td>' + item.duration + '</td>'
              text += '<td>' + item.state + '</td>'
              text += '<td>' + ansi_up.ansi_to_html(item.CapturedTestOutput).replace(/\n/g, '<br>') + '</td></tr>'

            }

            id = id + 1
            if (eqData == "Optional" && tableName != "all") {
              text2 += text
              text2 += '</tbody></table>'
              text2 += '</div></div></div>'
            } else {
              text3 += text
              text3 += '</tbody></table>'
              text3 += '</div></div></div>'
            }
          }

        }
      }

      text2 += '</div></td></tr></tbody>'
      text3 += '</div></td></tr></tbody>'

      $(text3).appendTo($(element))
      $(text2).appendTo($(element2))

    }

    function generateFeedbackPage(input, input2, element, element2, tableName) {
      $(element).empty()
      // The results object is composed of multiple objects, 1 per test
      // Inside the object we have an array of results
      id = 1
      var ansi_up = new AnsiUp;

      tests_total = 0
      tests_passed = 0
      tests_skipped = 0
      tests_failed = 0
      tests_total_optional = 0
      tests_passed_optional = 0
      tests_skipped_optional = 0
      tests_failed_optional = 0
      // Compute number of passed/skipped/failed results
      for (const key in input) {

        for (const item of input[key]) {
          for (const key2 in input2) {

            eqData = input2[key2].FarEdge

            if (tableName == "telco") {
              eqData = input2[key2].Telco

            }
            if (tableName == "nontelco") {
              eqData = input2[key2].NonTelco
            }

            if (key == key2) {
              if (item.state == 'passed') {
                if (eqData == "Mandatory" || tableName == "all") {
                  tests_total++
                  tests_passed++
                } else {
                  tests_total_optional++
                  tests_passed_optional++
                }

              } else if (item.state == 'skipped') {
                if (eqData == "Mandatory" || tableName == "all") {
                  tests_total++
                  tests_skipped++
                } else {
                  tests_total_optional++
                  tests_skipped_optional++
                }

              } else if (item.state == 'failed') {
                if (eqData == "Mandatory" || tableName == "all") {
                  tests_total++
                  tests_failed++
                } else {
                  tests_total_optional++
                  tests_failed_optional++
                }
              }
            }
          }
        }
      }

      // First we will have a left column in the table with the summarized results
      if (tableName == "all") {
        text2 = '<thead><tr><th scope="col">All Test  summary</th><th scope="col">Test feedback</th></tr></thead><tbody>'

      } else {
        text2 = '<thead><tr><th scope="col">Mandatory Test  summary</th><th scope="col">Test feedback</th></tr></thead><tbody>'
      }
      text2 += '<tr><td class="align-top"><b>Total:</b> ' + tests_total + '<br><b>Passed:</b> ' + tests_passed + '<br><b>Skipped:</b> ' + tests_skipped + '<br><b>Failed:</b> ' + tests_failed + '</td><td>'
      text2 += '<div class="accordion" id="feedback-accordion">'

      // First we will have a left column in the table with the summarized results
      text3 = '<thead><tr><th scope="col">Optional Test summary</th><th scope="col">Test feedback</th></tr></thead><tbody>'
      text3 += '<tr><td class="align-top"><b>Total:</b> ' + tests_total_optional + '<br><b>Passed:</b> ' + tests_passed_optional + '<br><b>Skipped:</b> ' + tests_skipped_optional + '<br><b>Failed:</b> ' + tests_failed_optional + '</td><td>'
      text3 += '<div class="accordion" id="feedback-accordion">'

      for (const key in input) {
        for (const key2 in input2) {

          eqData = input2[key2].FarEdge

          if (tableName == "telco") {
            eqData = input2[key2].Telco

          }
          if (tableName == "nontelco") {
            eqData = input2[key2].NonTelco
          }

          if (key == key2) {
            text = ''
            // NOTE: we are assuming the test result is determined by the passed/failed state of the first item
            status = input[key][0].state
            if (status === "passed") {
              buttontype = 'bg-success text-white'
            } else if (status === "skipped") {
              buttontype = 'bg-warning text-black'
            } else {
              buttontype = 'bg-danger text-white'
            }

            itemid = 'collapse' + id
            headingid = 'heading' + id
            text += '<div class="accordion-item"><h2 class="accordion-header" id="' + headingid + '"><button class="accordion-button collapsed ' + buttontype + '" type="button" data-bs-toggle="collapse" data-bs-target="#' + itemid + '" aria-expanded="true" aria-controls="' + itemid + '">'
            text += 'Feedback for ' + key + ' </button></h2>'
            // Now we should populate the item contents
            text += '<div id="' + itemid + '" class="accordion-collapse collapse" aria-labelledby="' + headingid + '" data-bs-parent="' + element + '">'
            text += '<div class="accordion-body">'
            // Inside the accordion, 1 table with the following colummns

            for (const item of input[key]) {
              testName = item.testID.id
              console.log(testName)
              text += '<textarea style="width: 100%; margin: 0 auto;" rows = "5" id="source-' + tableName + '-' + testName + '" type="text" ></textarea>'
            }
            if (eqData == "Optional" && tableName != "all") {
              text3 += text
            } else {
              text2 += text

            }
            // Note we are skipping some columns for now
            // And 1 row per test
            text2 += '</div></div></div>'
            text3 += '</div></div></div>'
            id = id + 1
          }
        }
      }
      text2 += '</div></td></tr>'
      text2 += '</tbody>'
      text3 += '</div></td></tr>'
      text3 += '</tbody>'
      $(text2).appendTo($(element))
      $(text3).appendTo($(element2))

    }

    function download() {
      text = ""
      var selectBox = document.getElementById("selectBox");
      var tableName = selectBox.options[selectBox.selectedIndex].value;

      for (const key in this.json.claim.results) {
        for (const key2 in this.classification) {



          if (key == key2) {
            var data = document.getElementById('source-' + tableName + '-' + key)
            if (data != null) {
              text += key + ": "
              text += data.value + "\n"
            }
          }
        }
      }
      var pom = document.createElement('a');
      pom.setAttribute('href', 'data:text/plain;charset=utf-8,' +

        encodeURIComponent(text));
      pom.setAttribute('download', "feedback");

      pom.style.display = 'none';
      document.body.appendChild(pom);

      pom.click();

      document.body.removeChild(pom);
    }

    function sendMail() {

      text = "Feed back for every test case \n"
      var selectBox = document.getElementById("selectBox");
      var tableName = selectBox.options[selectBox.selectedIndex].value;

      for (const key in this.json.claim.results) {
        for (const key2 in this.classification) {
          if (key == key2) {
            var data = document.getElementById('source-' + tableName + '-' + key)
            if (data != null) {
              text += key + ": "
              text += data.value + "\n"
            }
          }
        }
      }

      var link = "mailto:me@example.com"
        + "?cc="
        + "&subject=" + encodeURIComponent("Feed Back for Results")
        + "&body=" + encodeURIComponent(text)
        ;

      window.location.href = link;
    }


  </script>
  <!-- This will load the initial JSON file, if present. It may fail. -->
  <script src="./claimjson.js"></script>
  <script src="./classification.js"></script>

  <script>
    // Load initial json, if available
    if (typeof initialjson !== 'undefined') {
      fillConfig(initialjson.claim.configurations, '#config-table')
      fillConfig(initialjson.claim.nodes, '#nodes-table')
      fillMetadata(initialjson.claim.metadata, '#metadata-table')
      fillVersions(initialjson.claim.versions, '#versions-table')
      fillResults(initialjson.claim.results, '#results-table', '#optional-table', "ALL")
      fillResults(initialjson.claim.results, classification.classification, '#results-far-edge-table', '#optional-table', "FarEdge")

      generateFeedbackPage(initialjson.claim.results, classification.classification, '#feedback-table-faredge', "FarEdge")
    }
    const inputElement = document.getElementById("formFile");
    inputElement.addEventListener("change", handleFiles, false);
    function handleFiles() {
      const fileList = this.files; /* now you can work with the file list */
      if (fileList.length) {
        // We have a file to load
        let fileUploaded = new FileReader();
        fileUploaded.addEventListener("load", e => {
          json = JSON.parse(fileUploaded.result)
          fillConfig(json.claim.configurations, '#config-table')
          fillConfig(json.claim.nodes, '#nodes-table')
          fillMetadata(json.claim.metadata, '#metadata-table')
          fillVersions(json.claim.versions, '#versions-table')
          fillResults(json.claim.results, classification, '#results-table', '#optional-', "all")
          fillResults(json.claim.results, classification, '#results-far-edge-table', '#optional-table', "faredge")
          fillResults(json.claim.results, classification, '#results-telco-table', '#optional-table-telco', "telco")
          fillResults(json.claim.results, classification, '#results-NonTelco-table', '#optional-table-non-telco', "nontelco")
          generateFeedbackPage(json.claim.results, classification, '#feedback-all', '#optional-', "all")
          generateFeedbackPage(json.claim.results, classification, '#feedback-table-faredge', '#optional-faredge-feedback', "faredge")
          generateFeedbackPage(json.claim.results, classification, '#feedback-table-non-telco', '#optional-table-non-telco-feedback', "nontelco")
          generateFeedbackPage(json.claim.results, classification, '#feedback-table-telco', '#optional-table-telco-feedback', "telco")

        });
        fileUploaded.readAsText(fileList[0]);
      }
    }
  </script>
</body>

</html>